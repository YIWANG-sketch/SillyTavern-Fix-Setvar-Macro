# Fix Setvar Macro - 测试指南

本文档提供了详细的测试步骤，用于验证扩展的功能是否正常工作。

## 测试环境

- SillyTavern staging 分支
- 浏览器开发者工具（用于查看日志）

## 测试前准备

1. 确保扩展已正确安装
2. 打开浏览器开发者工具（F12）
3. 切换到 Console 标签页
4. 在扩展设置中启用 **启用调试日志**

## 测试用例

### 测试 1：基本管道符转义

**目的**：验证扩展能正确转义宏中的管道符

**步骤**：
1. 在聊天中发送消息：`{{setvar::test::|value|}}`
2. 查看控制台日志
3. 检查消息是否被修改为：`{{setvar::test::\|value\|}}`

**预期结果**：
- 控制台显示：`[fix-setvar-macro] Fixed pipes in 1 message(s)`
- 消息中的 `|` 被转义为 `\|`

---

### 测试 2：多个管道符

**目的**：验证扩展能处理多个管道符

**步骤**：
1. 发送消息：`{{setvar::test::|a|b|c|}}`
2. 查看控制台日志
3. 检查消息是否被修改为：`{{setvar::test::\|a\|b\|c\|}}`

**预期结果**：
- 所有 `|` 都被转义
- 控制台显示修复日志

---

### 测试 3：已转义的管道符

**目的**：验证扩展不会重复转义已转义的管道符

**步骤**：
1. 发送消息：`{{setvar::test::\|value\|}}`
2. 查看控制台日志
3. 检查消息是否保持不变

**预期结果**：
- 消息不被修改
- 控制台显示：`No fixes needed`

---

### 测试 4：混合转义和未转义

**目的**：验证扩展能正确处理混合情况

**步骤**：
1. 发送消息：`{{setvar::test::\|a|b\|c|}}`
2. 查看控制台日志
3. 检查消息是否被修改为：`{{setvar::test::\|a\|b\|c\|}}`

**预期结果**：
- 只有未转义的 `|` 被转义
- 已转义的 `\|` 保持不变

---

### 测试 5：多个宏

**目的**：验证扩展能处理多个宏

**步骤**：
1. 发送消息：`{{setvar::a::|1|}} {{addvar::b::|2|}}`
2. 查看控制台日志
3. 检查两个宏中的管道符是否都被转义

**预期结果**：
- 两个宏中的 `|` 都被转义
- 控制台显示修复日志

---

### 测试 6：不同的宏类型

**目的**：验证扩展支持所有目标宏

**步骤**：
1. 分别测试以下宏：
   - `{{setvar::test::|value|}}`
   - `{{setglobalvar::test::|value|}}`
   - `{{addvar::test::|value|}}`
   - `{{addglobalvar::test::|value|}}`
2. 查看控制台日志

**预期结果**：
- 所有宏类型都能正确处理
- 控制台显示相应的修复日志

---

### 测试 7：Swipes 处理

**目的**：验证扩展能处理 swipes 中的宏

**步骤**：
1. 发送包含宏的消息
2. 使用 swipe 功能生成多个变体
3. 在每个 swipe 中添加包含管道符的宏
4. 查看控制台日志

**预期结果**：
- 所有 swipes 中的宏都被正确处理
- 控制台显示处理的 swipes 数量

---

### 测试 8：编辑消息

**目的**：验证扩展能处理编辑后的消息

**步骤**：
1. 发送普通消息
2. 编辑消息，添加包含管道符的宏：`{{setvar::test::|value|}}`
3. 保存编辑
4. 查看控制台日志

**预期结果**：
- 编辑后的宏被正确转义
- 控制台显示：`[Event: MESSAGE_EDITED] Fixed N message(s)`

---

### 测试 9：切换聊天

**目的**：验证扩展在切换聊天时能处理历史消息

**步骤**：
1. 在聊天 A 中发送包含未转义管道符的宏
2. 切换到聊天 B
3. 切换回聊天 A
4. 查看控制台日志

**预期结果**：
- 切换回聊天 A 时，历史消息中的宏被处理
- 控制台显示：`[Event: CHAT_CHANGED] Fixed N message(s)`

---

### 测试 10：启用/禁用扩展

**目的**：验证扩展的开关功能

**步骤**：
1. 在扩展设置中取消勾选 **启用自动修复**
2. 发送包含管道符的宏
3. 检查消息是否未被修改
4. 重新勾选 **启用自动修复**
5. 再次发送包含管道符的宏
6. 检查消息是否被修改

**预期结果**：
- 禁用时，宏不被处理
- 启用时，宏被正确处理
- 控制台显示相应的状态变化日志

---

### 测试 11：调试模式

**目的**：验证调试日志功能

**步骤**：
1. 在扩展设置中启用 **启用调试日志**
2. 发送包含宏的消息
3. 查看控制台日志
4. 禁用 **启用调试日志**
5. 再次发送包含宏的消息
6. 查看控制台日志

**预期结果**：
- 启用调试模式时，控制台显示详细的调试信息（包含 `🔍 FSM:DEBUG` 前缀）
- 禁用调试模式时，只显示基本的信息日志（`✓ FSM:INFO` 前缀）

---

### 测试 12：性能测试

**目的**：验证扩展在处理大量消息时的性能

**步骤**：
1. 创建一个包含 100+ 条消息的聊天
2. 在多条消息中添加包含管道符的宏
3. 切换到该聊天
4. 查看控制台日志中的处理时间

**预期结果**：
- 扩展能在合理时间内处理所有消息（通常 < 100ms）
- 控制台显示处理时间统计

---

### 测试 13：边界情况 - 空宏

**目的**：验证扩展能处理空宏参数

**步骤**：
1. 发送消息：`{{setvar::test::}}`
2. 查看控制台日志

**预期结果**：
- 扩展不会崩溃
- 消息保持不变

---

### 测试 14：边界情况 - 嵌套宏

**目的**：验证扩展能处理嵌套宏

**步骤**：
1. 发送消息：`{{setvar::test::{{getvar::other}}|value|}}`
2. 查看控制台日志

**预期结果**：
- 外层宏中的 `|` 被正确转义
- 内层宏不受影响

---

### 测试 15：边界情况 - 特殊字符

**目的**：验证扩展能处理包含特殊字符的宏

**步骤**：
1. 发送消息：`{{setvar::test::|<>&"'|}}`
2. 查看控制台日志

**预期结果**：
- 管道符被正确转义
- 其他特殊字符不受影响

---

## 测试检查清单

- [ ] 测试 1：基本管道符转义
- [ ] 测试 2：多个管道符
- [ ] 测试 3：已转义的管道符
- [ ] 测试 4：混合转义和未转义
- [ ] 测试 5：多个宏
- [ ] 测试 6：不同的宏类型
- [ ] 测试 7：Swipes 处理
- [ ] 测试 8：编辑消息
- [ ] 测试 9：切换聊天
- [ ] 测试 10：启用/禁用扩展
- [ ] 测试 11：调试模式
- [ ] 测试 12：性能测试
- [ ] 测试 13：边界情况 - 空宏
- [ ] 测试 14：边界情况 - 嵌套宏
- [ ] 测试 15：边界情况 - 特殊字符

## 常见问题排查

### 问题 1：扩展未加载

**症状**：控制台没有任何 `[fix-setvar-macro]` 日志

**解决方案**：
1. 检查扩展文件是否正确放置在 `extensions/fix-setvar-macro/` 目录
2. 检查 `manifest.json` 是否正确
3. 重启 SillyTavern

### 问题 2：宏未被修复

**症状**：消息中的管道符未被转义

**解决方案**：
1. 检查扩展是否已启用（设置面板中的复选框）
2. 检查控制台是否有错误日志
3. 启用调试模式，查看详细日志

### 问题 3：性能问题

**症状**：处理消息时出现明显延迟

**解决方案**：
1. 检查聊天中的消息数量
2. 查看控制台中的处理时间统计
3. 如果处理时间过长（> 500ms），考虑优化或报告问题

## 报告问题

如果在测试过程中发现问题，请提供以下信息：

1. 测试用例编号
2. 实际结果与预期结果的差异
3. 控制台日志截图
4. SillyTavern 版本和分支
5. 浏览器类型和版本
